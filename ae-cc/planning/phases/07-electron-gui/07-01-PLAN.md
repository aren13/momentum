# Phase 7, Plan 1: Electron Desktop App - Foundation

## Objective

Create the Electron app shell with React frontend, establishing the architecture for the GUI layer that visualizes and controls Momentum CLI operations.

## Context

**Architecture Principle:** CLI remains the source of truth. GUI is a visualization layer.

```
┌─────────────────────────────────────────────────────────┐
│                   Electron App                          │
│  ┌───────────────────────────────────────────────────┐  │
│  │              React Frontend                       │  │
│  │  ┌─────────┐ ┌─────────┐ ┌──────────────────┐    │  │
│  │  │ Kanban  │ │Dashboard│ │ Agent Terminals  │    │  │
│  │  └────┬────┘ └────┬────┘ └────────┬─────────┘    │  │
│  └───────┼───────────┼───────────────┼──────────────┘  │
│          │           │               │                  │
│  ┌───────┴───────────┴───────────────┴──────────────┐  │
│  │              IPC Bridge Layer                     │  │
│  └───────────────────────┬──────────────────────────┘  │
└──────────────────────────┼──────────────────────────────┘
                           │
                           ▼
              ┌────────────────────────┐
              │    Momentum CLI        │
              │  (Source of Truth)     │
              └────────────────────────┘
```

## Tasks

### Task 1: Initialize Electron Project

**Type:** create
**Files:** `momentum/electron/`
**Action:** Set up Electron + React project structure

```bash
# Directory structure
momentum/
├── electron/
│   ├── package.json
│   ├── main/
│   │   ├── index.js          # Main process entry
│   │   ├── ipc-handlers.js   # CLI bridge
│   │   ├── window.js         # Window management
│   │   └── tray.js           # System tray
│   ├── renderer/
│   │   ├── index.html
│   │   ├── index.jsx         # React entry
│   │   ├── App.jsx
│   │   ├── components/
│   │   ├── hooks/
│   │   └── styles/
│   ├── preload.js            # Context bridge
│   └── electron-builder.json # Build config
```

**package.json:**
```json
{
  "name": "momentum-gui",
  "version": "1.0.0",
  "main": "main/index.js",
  "scripts": {
    "start": "electron .",
    "dev": "concurrently \"vite\" \"electron .\"",
    "build": "vite build && electron-builder"
  },
  "dependencies": {
    "electron": "^28.0.0"
  },
  "devDependencies": {
    "vite": "^5.0.0",
    "@vitejs/plugin-react": "^4.0.0",
    "electron-builder": "^24.0.0",
    "concurrently": "^8.0.0"
  }
}
```

**Verify:**
- [ ] Project structure created
- [ ] Dependencies installable
- [ ] Electron starts

**Done:** [ ]

---

### Task 2: Create Main Process

**Type:** create
**Files:** `momentum/electron/main/index.js`
**Action:** Set up Electron main process with window management

```javascript
/**
 * Momentum GUI - Main Process
 */
const { app, BrowserWindow, ipcMain, Tray, Menu } = require('electron');
const path = require('path');
const { setupIpcHandlers } = require('./ipc-handlers');
const { createTray } = require('./tray');

let mainWindow = null;
let tray = null;

function createWindow() {
  mainWindow = new BrowserWindow({
    width: 1400,
    height: 900,
    minWidth: 1000,
    minHeight: 700,
    titleBarStyle: 'hiddenInset',
    webPreferences: {
      preload: path.join(__dirname, '../preload.js'),
      contextIsolation: true,
      nodeIntegration: false
    }
  });

  // Load React app
  if (process.env.NODE_ENV === 'development') {
    mainWindow.loadURL('http://localhost:5173');
    mainWindow.webContents.openDevTools();
  } else {
    mainWindow.loadFile(path.join(__dirname, '../renderer/dist/index.html'));
  }

  mainWindow.on('closed', () => {
    mainWindow = null;
  });

  return mainWindow;
}

app.whenReady().then(() => {
  createWindow();
  tray = createTray(mainWindow);
  setupIpcHandlers(ipcMain);

  app.on('activate', () => {
    if (BrowserWindow.getAllWindows().length === 0) {
      createWindow();
    }
  });
});

app.on('window-all-closed', () => {
  if (process.platform !== 'darwin') {
    app.quit();
  }
});
```

**Verify:**
- [ ] Window creates successfully
- [ ] Dev mode with hot reload works
- [ ] Production build works

**Done:** [ ]

---

### Task 3: Create IPC Bridge to CLI

**Type:** create
**Files:** `momentum/electron/main/ipc-handlers.js`
**Action:** Bridge GUI to Momentum CLI commands

```javascript
/**
 * IPC Handlers - Bridge to Momentum CLI
 */
const { spawn, exec } = require('child_process');
const path = require('path');

// Track running agents for live output
const runningAgents = new Map();

function setupIpcHandlers(ipcMain) {

  // Execute CLI command
  ipcMain.handle('cli:execute', async (event, { command, args, cwd }) => {
    return new Promise((resolve, reject) => {
      const process = spawn('momentum', [command, ...args], {
        cwd: cwd || process.cwd(),
        shell: true
      });

      let stdout = '';
      let stderr = '';

      process.stdout.on('data', (data) => {
        stdout += data.toString();
      });

      process.stderr.on('data', (data) => {
        stderr += data.toString();
      });

      process.on('close', (code) => {
        if (code === 0) {
          resolve({ success: true, stdout, stderr });
        } else {
          reject({ success: false, stdout, stderr, code });
        }
      });
    });
  });

  // Get project status
  ipcMain.handle('project:status', async (event, { projectPath }) => {
    return executeCommand('momentum', ['status', '--json'], projectPath);
  });

  // Get roadmap
  ipcMain.handle('project:roadmap', async (event, { projectPath }) => {
    return executeCommand('momentum', ['roadmap', '--json'], projectPath);
  });

  // Execute plan
  ipcMain.handle('plan:execute', async (event, { planPath, projectPath }) => {
    const process = spawn('momentum', ['execute', planPath], {
      cwd: projectPath,
      shell: true
    });

    const agentId = `agent-${Date.now()}`;
    runningAgents.set(agentId, process);

    // Stream output to renderer
    process.stdout.on('data', (data) => {
      event.sender.send('agent:output', { agentId, data: data.toString() });
    });

    process.stderr.on('data', (data) => {
      event.sender.send('agent:error', { agentId, data: data.toString() });
    });

    process.on('close', (code) => {
      event.sender.send('agent:complete', { agentId, code });
      runningAgents.delete(agentId);
    });

    return { agentId };
  });

  // Kill agent
  ipcMain.handle('agent:kill', async (event, { agentId }) => {
    const process = runningAgents.get(agentId);
    if (process) {
      process.kill('SIGTERM');
      runningAgents.delete(agentId);
      return { success: true };
    }
    return { success: false, error: 'Agent not found' };
  });

  // List worktrees
  ipcMain.handle('worktree:list', async (event, { projectPath }) => {
    return executeCommand('momentum', ['worktree', 'list', '--json'], projectPath);
  });

  // Open project folder
  ipcMain.handle('shell:openFolder', async (event, { path }) => {
    const { shell } = require('electron');
    shell.openPath(path);
  });
}

async function executeCommand(cmd, args, cwd) {
  return new Promise((resolve) => {
    exec(`${cmd} ${args.join(' ')}`, { cwd }, (error, stdout, stderr) => {
      resolve({
        success: !error,
        stdout,
        stderr,
        error: error?.message
      });
    });
  });
}

module.exports = { setupIpcHandlers };
```

**Verify:**
- [ ] CLI commands execute from GUI
- [ ] Live output streams to renderer
- [ ] Agent lifecycle managed

**Done:** [ ]

---

### Task 4: Create Preload Script

**Type:** create
**Files:** `momentum/electron/preload.js`
**Action:** Secure context bridge for renderer

```javascript
/**
 * Preload Script - Secure bridge between main and renderer
 */
const { contextBridge, ipcRenderer } = require('electron');

contextBridge.exposeInMainWorld('momentum', {
  // CLI execution
  execute: (command, args, cwd) =>
    ipcRenderer.invoke('cli:execute', { command, args, cwd }),

  // Project operations
  getStatus: (projectPath) =>
    ipcRenderer.invoke('project:status', { projectPath }),

  getRoadmap: (projectPath) =>
    ipcRenderer.invoke('project:roadmap', { projectPath }),

  // Plan execution
  executePlan: (planPath, projectPath) =>
    ipcRenderer.invoke('plan:execute', { planPath, projectPath }),

  // Agent management
  killAgent: (agentId) =>
    ipcRenderer.invoke('agent:kill', { agentId }),

  // Worktrees
  listWorktrees: (projectPath) =>
    ipcRenderer.invoke('worktree:list', { projectPath }),

  // Shell
  openFolder: (path) =>
    ipcRenderer.invoke('shell:openFolder', { path }),

  // Event listeners
  onAgentOutput: (callback) =>
    ipcRenderer.on('agent:output', (_, data) => callback(data)),

  onAgentError: (callback) =>
    ipcRenderer.on('agent:error', (_, data) => callback(data)),

  onAgentComplete: (callback) =>
    ipcRenderer.on('agent:complete', (_, data) => callback(data)),

  // Cleanup listeners
  removeAllListeners: (channel) =>
    ipcRenderer.removeAllListeners(channel)
});
```

**Verify:**
- [ ] API exposed to renderer
- [ ] Context isolation maintained
- [ ] Events propagate correctly

**Done:** [ ]

---

### Task 5: Create React App Shell

**Type:** create
**Files:** `momentum/electron/renderer/`
**Action:** Set up React app with routing and layout

```jsx
// App.jsx
import { useState, useEffect } from 'react';
import { Sidebar } from './components/Sidebar';
import { Dashboard } from './components/Dashboard';
import { Kanban } from './components/Kanban';
import { AgentTerminals } from './components/AgentTerminals';
import { ContextInspector } from './components/ContextInspector';
import { Settings } from './components/Settings';
import './styles/app.css';

export default function App() {
  const [view, setView] = useState('dashboard');
  const [project, setProject] = useState(null);
  const [agents, setAgents] = useState([]);

  useEffect(() => {
    // Load last project or prompt selection
    loadProject();
  }, []);

  const loadProject = async () => {
    const status = await window.momentum.getStatus(process.cwd());
    if (status.success) {
      setProject(JSON.parse(status.stdout));
    }
  };

  return (
    <div className="app">
      <Sidebar
        currentView={view}
        onNavigate={setView}
        project={project}
      />

      <main className="main-content">
        {view === 'dashboard' && (
          <Dashboard project={project} agents={agents} />
        )}

        {view === 'kanban' && (
          <Kanban project={project} onRefresh={loadProject} />
        )}

        {view === 'agents' && (
          <AgentTerminals
            agents={agents}
            onAgentChange={setAgents}
          />
        )}

        {view === 'context' && (
          <ContextInspector project={project} />
        )}

        {view === 'settings' && (
          <Settings onSave={loadProject} />
        )}
      </main>
    </div>
  );
}
```

**Verify:**
- [ ] React app renders
- [ ] Navigation works
- [ ] Project loads on start

**Done:** [ ]

---

## Verification Steps

1. [ ] `cd electron && npm install` succeeds
2. [ ] `npm run dev` starts app with hot reload
3. [ ] Window appears with sidebar
4. [ ] IPC bridge connects to CLI
5. [ ] `momentum status` executes from GUI
6. [ ] `npm run build` creates distributable

## Success Criteria

- Electron app shell functional
- IPC bridge to CLI working
- React frontend rendering
- Ready for component development (Plan 2)

## Output

Create `07-01-SUMMARY.md` documenting:
- Architecture decisions
- IPC API surface
- Build configuration
- Next steps for Kanban/Dashboard components

---

*Generated by Momentum Planning*
