# Plan 01-02: Worktree-Aware Context Resolution

> Implement context resolution that understands git worktrees and resolves paths correctly within worktree contexts.

---

## Objective

When executing tasks in a worktree, the context resolver should automatically detect the worktree environment, resolve file paths relative to the worktree root, and provide worktree metadata (name, branch, base) to prompts and execution output. This ensures seamless operation when working in isolated worktree environments.

---

## Context

- **Phase:** 1 - Git Worktree Engine
- **Depends on:** Plan 01-01 (WorktreeManager implementation)
- **Related files:**
  - `momentum/lib/core/worktree.js` (WorktreeManager)
  - `momentum/lib/core/context.js` (ContextEngine)
  - `momentum/lib/core/executor.js` (PlanExecutor)

The WorktreeManager is now functional, but the rest of the system doesn't yet understand when it's operating in a worktree context. This plan adds that awareness.

---

## Tasks

### Task 1: Create WorktreeContext class

**Description:**
Create a new `WorktreeContext` class that detects if the current working directory is within a git worktree and provides context-aware path resolution and metadata.

**Files involved:**
- `momentum/lib/core/worktree-context.js` (new)

**Implementation details:**
- Detect if current directory is inside a worktree by checking `.git` file (worktrees have a file, not a directory)
- Parse worktree metadata from `.git` file
- Resolve paths relative to worktree root
- Get worktree name, branch, and base branch
- Provide formatted context strings for prompts

**Verification:**
- Can detect worktree vs main repository
- Correctly parses worktree metadata
- Resolves paths relative to worktree root
- Returns null when not in a worktree

---

### Task 2: Integrate WorktreeContext into ContextEngine

**Description:**
Modify the ContextEngine to use WorktreeContext for path resolution and include worktree information in context output.

**Files involved:**
- `momentum/lib/core/context.js`
- `momentum/lib/core/worktree-context.js`

**Implementation details:**
- Import and instantiate WorktreeContext at the start of operations
- Check for worktree context before resolving paths
- Adjust `loadFullContext()` to use worktree-relative paths
- Add worktree info section to context exports
- Include worktree status in `showContextStatus()`

**Verification:**
- Context correctly resolves paths in worktree
- `momentum context` shows worktree info when in worktree
- Handoff documents include worktree context

---

### Task 3: Add worktree info to executor output

**Description:**
Enhance the PlanExecutor to display which worktree the task is running in, including branch name in progress displays.

**Files involved:**
- `momentum/lib/core/executor.js`
- `momentum/lib/core/worktree-context.js`

**Implementation details:**
- Use WorktreeContext to detect execution environment
- Display worktree info at start of execution
- Include branch name in task progress output
- Show worktree path in execution summary
- Add worktree context to commit messages

**Verification:**
- Executor shows "Executing in worktree: X (branch: Y)" message
- Task progress includes worktree branch indicator
- Summary shows worktree execution context
- Clear indication when running in main vs worktree

---

## Verification Steps

1. [ ] Create a worktree with `WorktreeManager.create()`
2. [ ] Change to worktree directory
3. [ ] Run `momentum context` and verify worktree info is shown
4. [ ] Execute a plan in the worktree
5. [ ] Verify executor output shows worktree context
6. [ ] Check that paths are resolved relative to worktree root
7. [ ] Return to main repository and verify normal behavior
8. [ ] Export context and verify worktree info is included

---

## Success Criteria

- ✅ WorktreeContext correctly detects worktree vs main repo
- ✅ ContextEngine uses worktree-aware path resolution
- ✅ Executor displays worktree information during execution
- ✅ All operations work seamlessly in both contexts
- ✅ Clear visual indication of worktree context to user
- ✅ Path resolution is automatic and transparent

---

## Dependencies

- Plan 01-01 (WorktreeManager must be implemented)

---

## Estimated Duration

~30-45 minutes

---

*Generated: 2025-12-18*
