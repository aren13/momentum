# Plan 05-01: Core MergeResolver Class

**Phase:** 5 - Merge Resolution
**Objective:** Implement core MergeResolver class with conflict detection and AI-powered resolution strategies

---

## Tasks

### Task 1: Create MergeResolver Class
**File:** `momentum/lib/core/merge-resolver.js`

**Requirements:**
- Create `MergeResolver` class with the following methods:
  - `analyze(worktree, target)` - Detect conflicts between branches
  - `parseConflict(conflictText)` - Parse git conflict markers (`<<<<<<<`, `=======`, `>>>>>>>`)
  - `getConflictContext(file, conflict)` - Get surrounding code context for AI understanding
  - `generateResolutionPrompt(conflict)` - Create AI prompt for resolution
- Implement three-tier resolution strategy:
  1. **Auto (git)** - Try standard git merge first
  2. **Conflict-only AI** - Send just conflicted sections to AI
  3. **Full-file AI** - Send entire file with context if conflict is complex
- Track resolution statistics (auto-resolved, AI-resolved, manual)

**Success Criteria:**
- Can detect merge conflicts before attempting merge
- Correctly parses git conflict markers
- Returns structured conflict data with context
- Three-tier strategy escalates appropriately

---

### Task 2: Create Conflict Detection Utilities
**File:** `momentum/lib/core/conflict-detector.js`

**Requirements:**
- Create `ConflictDetector` class with methods:
  - `detectConflicts(worktree, target)` - Detect merge conflicts before merge
  - `categorizeConflict(conflict)` - Categorize as trivial, moderate, or complex
  - `estimateDifficulty(conflict)` - Estimate resolution difficulty (0-100 score)
- Implement conflict categorization logic:
  - **Trivial:** Whitespace, formatting, imports
  - **Moderate:** Non-overlapping logic changes
  - **Complex:** Overlapping logic, architecture changes
- Calculate difficulty based on:
  - Lines changed
  - Code complexity (nesting, functions)
  - Number of conflict markers
  - File type

**Success Criteria:**
- Accurately categorizes conflicts
- Difficulty scores correlate with actual complexity
- Can preview conflicts without modifying working tree

---

### Task 3: Add Merge Command Enhancements
**File:** `momentum/commands/merge.md`

**Requirements:**
- Create new slash command for merge operations
- Add conflict preview functionality:
  - Show conflicts before merge
  - Display resolution suggestions
  - Interactive conflict resolution workflow
- Support flags:
  - `--preview` - Show conflicts without merging
  - `--auto` - Auto-resolve when possible
  - `--strategy <auto|ai|manual>` - Force resolution strategy
- Integration with WorktreeManager's merge() method

**Success Criteria:**
- Command shows clear conflict preview
- User can choose resolution strategy
- Provides clear feedback on merge status

---

## Verification

**Integration Tests:**
1. Create two worktrees with conflicting changes
2. Run conflict detection
3. Verify categorization is accurate
4. Test three-tier resolution strategy
5. Confirm statistics tracking

**Edge Cases:**
- Binary file conflicts
- Renamed files
- Deleted vs modified conflicts
- Multiple conflicts in same file

---

## Dependencies

**Requires:**
- `WorktreeManager` (Phase 1)
- Git 2.5+ (for worktree support)

**Provides:**
- `MergeResolver` class for use in Phase 5.2
- `ConflictDetector` utilities
- Enhanced merge command

---

## Estimated Complexity
**Medium-High** - Requires git integration, conflict parsing, and AI prompt generation

---

*Created: 2025-12-18*
